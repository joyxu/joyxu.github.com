---
title: 内存冷热和层级内存
author: Joy Xu
date: 2024-05-10 02:31:10
tags: [memory, swap, tired memeory]
---

# 背景知识

## 内存冷热

所谓冷热是针对处理器中的cache来说的，冷就是页不大可能在cache中，热就是有很大几率在cache中。

cold page和hot page的概念可以参考LWN的文章[Hot and cold pages](http://lwn.net/Articles/14768/),从2.5.45内核，Martin Bligh和Andrew Morton提交了一个内核分配器patch，引入了hot-n-cold pages的概念。

对应到数据结构的话，就是 `struct zone` 下的 `struct per_cpu_pages`。

当kernel需要分配一个page时，通常会从per-CPU的hot list获取页面。当然也有些情况下，申请hot page不会获得性能上的提高，只要申请cold page就可以了。比如DMA读操作需要的内存分配，设备会直接修改内存并且无效相应的cache，所以内核分配器提供了GFP_COLD分配标记来声明从cold page链表分配内存。
`buffered_rmqueue`用于从冷热分配器中分配单页的缓存页。如果`gfp_flags`中指定的`__GFP_COLD`，则从冷缓存中分配一页，否则，从热缓存中分配。


## linux kernel 内存回收机制

只有list存放冷热页，一旦list满了之后，冷热的机制就玩不转了，所以还需要淘汰机制，从list里面淘汰冷页。
内核中的内存页面回收的算法就叫做PFRA(page frame reclaiming algorithm)，这个算法主要要做的就是：

* 回收什么样的页面
* 什么时候回收 &如何回收

### 回收什么样的页

#### 不可回收页

* 空闲页：已经在伙伴系统中的页，如前边分析，我们回收页的最终去向是伙伴系统，因此已经在`free_list`中的页是不无须也无法再回收的。

* 保留页：被标记为`PG_reserved`的页，一般这些用都是用来重要部分的内存，例如内核镜像位置、驱动的重要区域

* 锁定页: 被标记为`PG_locked`的页，锁定页通常是正在使用的页，比如正在写入或者读取的page cache页，这种页由于正在使用中，所以也不能进行操作。

另外下边这些页由于是在内核态，涉及到操作系统本身的运行，因此也是不可以回收的：

* 内核动态分配页：用kmalloc申请的内存和slab中已经分配的内存（被标记为`PG_slab`）。

* 进程内核态堆栈页：`task_struct`对应的内存空间，释放了就找不到进程对应的信息了。

#### 可回收页

* 可回收页：匿名页，通常就是有malloc申请出来的页，一般通过检查`PAGE_MAPPING_ANON`来看是否是匿名页；还有Tmpfs文件系统的映射页

* 可同步页：通过执行sync操作把页的内容写回到磁盘中，再进行回收利用，也被叫做脏页，包括：映射页、存有磁盘文件数据且在页高速缓存中的页、块设备缓冲区页和某些磁盘高速缓存的页（如索引节点高速缓存）。

* 可丢弃页: 内存高速缓存中的未使用页（如slab分配器高速缓存），分配在slab中，但是还空闲没有被使用的部分，可以被系统通过slab分配器主动回收; 目录项高速缓存的未使用页，用于缓存文件系统中的目录项（dentry）。目录项表示了文件系统中文件和目录的结构。

### 什么时候回收&如何回收

有两种回收方式，直接回收和异步周期回收。
异步周期回收一般就是kswapd，当空间内存低于水位时，开始执行。
直接回收是在`alloc_page`时，且水位低于min时，直接调用kswap，回收内存。

整体如下：

![reclaim overall process](/images/hot-n-cold-memory-reclaim.png)

详细的代码流程可以参考 [Linux内存管理 - zoned page frame allocator - 5 ](https://www.cnblogs.com/LoyenWang/p/11827153.html)

### swap

由于内存和磁盘的读写性能差异较大，Linux会在内存充裕时将空闲内存用于缓存磁盘数据，以提高I/O性能。相对的在内存紧张时Linux会将这些缓存回收，将脏页回写到磁盘中。
而在进程的地址空间中，如heap，stack等匿名页，在磁盘上并没有对应的文件，但同样有回收到磁盘上以释放出空闲内存的需求。
swap机制通过在磁盘上开辟专用的swap分区作为匿名页的backing storage，满足了这一需求。

Linux中存在两种形式的swap分区：swap disk和swap file。前者是一个专用于做swap的块设备，作为裸设备提供给swap机制操作；后者则是存放在文件系统上的一个特定文件，其实现依赖于不同的文件系统，会有所区别。

通过mkswap命令可以将一个swap disk或swap file转换为swap分区的格式。随后可通过swapon和swapoff命令开启或关闭对应的swap分区。通过cat /proc/swaps或swapon -s可以查看使用中的swap分区的状态。

![swap disk example](/images/hot-n-cold-memory-swap-example.png)

一个`swap_info_struct`对应一个swap分区。如下图所示，swap分区内部会以page大小为单位划分出多个swap slot，同时通过swap_map对每个slot的使用情况进行记录，为0代表空闲，大于0则代表该slot被map的进程数量。

![swap overview](/images/hot-n-cold-memory-swap.png)

swap流程如下：

![swap process](/images/hot-n-cold-memory-swap2.png)

# 整体overview

现在有了层级内存之后，实际上就是在swap之前，把这个页移动到延迟更大的内存上，整体思路如下：

![tire memory overview](/images/hot-n-cold-memory-overview.png)

中间涉及到的几个概念，LRU和rmap前面已经讲过。而user page fault，以及tire memory还没有介绍。

# 参考

* [Describing Physical Memory](https://www.kernel.org/doc/gorman/html/understand/understand005.html)
* [A Hybrid Swapping Scheme Based On Per-Process Reclaim for Performance Improvement of Android Smartphones (August 2018)](https://ieeexplore.ieee.org/document/8478216)
* [Linux Swap 介绍](https://www.cnblogs.com/Linux-tech/p/14110331.html)
* [Linux内存管理 - zoned page frame allocator - 5 ](https://www.cnblogs.com/LoyenWang/p/11827153.html)
* [Better caching using reinforcement learning](https://wiki.ubc.ca/Better_caching_using_reinforcement_learning)
* [20 YEARS OF LINUX VIRTUAL MEMORY](https://kernel-recipes.org/en/2017/talks/20-years-of-linux-virtual-memory/)
* [20 YEARS OF LINUX VIRTUAL MEMORY](https://archive.fosdem.org/2017/schedule/event/iaas_20yealin/)
* [Linux mem 2.4 Buddy 内存管理机制](https://www.cnblogs.com/pwl999/p/15534977.html)
* [内存管理4-页面回收](https://www.korantli.com.cn/nei-cun-guan-li-4-ye-mian-hui-shou/)
* [linux内存回收(一）---kswapd回收](https://blog.csdn.net/u012489236/article/details/120587124)
* [Memoptimizer watches your memory usage so you don’t have to!](https://events.linuxfoundation.org/wp-content/uploads/2021/10/LF_Live_memoptimizer.pdf)

