title: 小谈虚拟化中的中断演进
author: Joy Xu
date: 2017-09-04 16:11:56
tags: [Virtualization, Linux Kernel]
---
# 目的

本文主要跟踪Linux kerenl中断系统虚拟化方向的演进，
希望能尽量用少的篇幅把整个虚拟化中断说清楚。

# 读者
本文假设读者已有linux中断的编程经验，熟悉ARM GIC的基本概念和工作原理。

# 总述

QEMU/KVM中，设备虚拟化有3种方法：纯软件模拟，virtio虚拟和SRIOV物理分配。
本文先集中解析virtio pci虚拟设备的中断，后续再补充SRIOV设备的中断，
不讨论纯软件模拟设备的中断过程。

# QEMU/KVM软件堆栈和virtio简介

在介绍中断细节前先介绍下整个系统的组成，再以网络收发包为例介绍中断细节。

## QEMU/KVM软件堆栈

系统的软件组成如下图：

![QEMU/KVM组成图](http://7vilkn.com1.z0.glb.clouddn.com/QEMU_KVM.png)

* Event Loop：监听fd，一旦fd收到event即调用回调函数
* vCPU Thread： 执行guest代码的
* Worker Thread：执行阻塞代码，完成时通知Event Loop

## VirtIO关键数据结构关系

![VirtIO关键数据结构图](http://7vilkn.com1.z0.glb.clouddn.com/virtio.gif)

其中virtqueue_ops结构体在2.6内核之后已经被去掉，直接使用函数代替;代码位置请以最新内核为准。
vring_virtqueue封装了vring和vritqueue，vring是底层的物理内存实现。
已知virtqueue的话，可以通过container_of找到vring_virtqueue.

## VirtIO设备和外界数据交互

交互的流程图如下：

![VirtIO设备和外界数据交互图](http://7vilkn.com1.z0.glb.clouddn.com/KVM_QEMU_virtIO_Process.PNG)

1. 虚拟机中，VirtIO设备驱动通过virtqueue的add_buf函数，把request写入到virtqueue中；
2. 虚拟机中，VirtIO设备驱动通过virtqueue的kick函数产生exception唤醒host；
3. host中的QEMU Event Loop监听到该exception，执行回调函数；
4. host中回调函数把虚拟机中的request数据转发给真实物理设备；
5. host把真实物理设备response数据通过virtqueue的get_buf写入到virtqueue中；
6. QEMU调用host的KVM模块的irqfd接口来注入中断请求；
7. host的KVM模块产生vIRQ把上报给GICC；
8. 虚拟机收到中断请求，处理response数据。

以virtio net为例，细节如下图：

### 发包流程：

![virtio net tx流程图](http://7vilkn.com1.z0.glb.clouddn.com/virtio-net-tx.png)

### 收包流程：

![virtio net tx流程图](http://7vilkn.com1.z0.glb.clouddn.com/virtio-net-rx.png)

# GIC简介

软件主要控制GIC的GICD、GICR和GICC。

![GIC编程接口图](http://7vilkn.com1.z0.glb.clouddn.com/The%20programming%20interfaces%20of%20a%20GICv3%20interrupt%20controller.png)

ITS和GIC的关系如下，注意LPI可以不经过ITS直接发给GICR。
![ITS编程接口图](http://7vilkn.com1.z0.glb.clouddn.com/An%20ITS%20forwarding%20an%20LPI%20to%20a%20Redistributor.png)

# GICv3时代的虚拟机中断处理机制

![GICv3中断处理流程图](http://7vilkn.com1.z0.glb.clouddn.com/forwarding_a_physical_interrupt_to_a_vPE_undirectly.png)

# GICv4时代的虚拟机中断处理机制

![GICv4 VLPI直通流程图](http://7vilkn.com1.z0.glb.clouddn.com/VLPI-forward-its.png)
